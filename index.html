<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿ä»²é–‹ç™¼ä¿¡ç”¢ç”Ÿå™¨ PRO v7.1</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS (æ¨£å¼åº«) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ React èˆ‡ ReactDOM (æ ¸å¿ƒæ¡†æ¶) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. è¼‰å…¥ Babel (è®“ç€è¦½å™¨çœ‹æ‡‚ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. å®šç¾©è‡ªè¨‚æ¨£å¼ -->
    <style>
        /* è‡ªå®šç¾©æ²è»¸æ¨£å¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            background-color: #020617; /* slate-950 */
            -webkit-user-select: none; /* Chrome/Safari/Opera */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
        }
        /* å…è¨±è¼¸å…¥æ¡†å¯ä»¥é¸å–æ–‡å­— */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
    </style>

    <!-- é˜²ç›œè…³æœ¬ï¼šç¦æ­¢å³éµèˆ‡é–‹ç™¼è€…å·¥å…· -->
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        
        document.onkeydown = function(e) {
            // F12
            if(e.keyCode == 123) {
                return false;
            }
            // Ctrl+Shift+I (Inspect)
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            // Ctrl+Shift+J (Console)
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            // Ctrl+Shift+C (Element Inspector)
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) {
                return false;
            }
            // Ctrl+U (View Source)
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- 5. ä¸»ç¨‹å¼ç¢¼é–‹å§‹ -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICON å…ƒä»¶å®šç¾© ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            Copy: (p) => <IconBase {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>,
            RefreshCw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>,
            MessageCircle: (p) => <IconBase {...p}><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></IconBase>,
            Share2: (p) => <IconBase {...p}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            User: (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            Briefcase: (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>,
            Sparkles: (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></IconBase>,
            ChevronDown: (p) => <IconBase {...p}><path d="m6 9 6 6 6-6"/></IconBase>,
            ChevronUp: (p) => <IconBase {...p}><path d="m18 15-6-6-6 6"/></IconBase>,
            Settings: (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Phone: (p) => <IconBase {...p}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconBase>,
            Mail: (p) => <IconBase {...p}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></IconBase>,
            AlertTriangle: (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>,
            Bot: (p) => <IconBase {...p}><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            RotateCcw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>,
            ArrowUp: (p) => <IconBase {...p}><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></IconBase>,
            ArrowDown: (p) => <IconBase {...p}><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></IconBase>,
            Smartphone: (p) => <IconBase {...p}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            Key: (p) => <IconBase {...p}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></IconBase>
        };

        // --- å¸¸æ•¸è¨­å®šå€ (å¯åœ¨æ­¤ä¿®æ”¹) ---

        // é è¨­ Key è¨­ç‚ºç©ºï¼Œä»£è¡¨é è¨­ä½¿ç”¨ GAS
        const DEFAULT_API_KEY = ""; 

        // Google Apps Script (GAS) éƒ¨ç½²ç¶²å€
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxT9RJys6Q6RKLT_Vcl8OWjcMYHoKmXOEW2Qrg1aXPaVn8G4C51GKopfF0dIDGX7ZJl/exec";

        // Base64 Encoded Password ("8899" -> "ODg5OQ==")
        const CORRECT_PASS_B64 = "ODg5OQ==";

        const TEAMS = [
            { value: "å¤§æ©˜åœ˜éšŠ", label: "å¤§æ©˜åœ˜éšŠ" },
            { value: "", label: "ç„¡ (ä¸é¡¯ç¤º)" }
        ];

        const STORES = [
            { value: "", label: "ç„¡ (ä¸é¡¯ç¤º)" },
            { value: "æœ‰å·¢æ°æˆ¿å±‹13æœŸå¾©åŒ—ç«‹è¾°åº—", label: "æœ‰å·¢æ°æˆ¿å±‹13æœŸå¾©åŒ—ç«‹è¾°åº—" },
            { value: "æ°¸æ…¶ä¸å‹•ç”¢å°ä¸­å…¬ç›Šå¤§æ¥­åº—", label: "æ°¸æ…¶ä¸å‹•ç”¢å°ä¸­å…¬ç›Šå¤§æ¥­åº—" }
        ];

        // åº—é ­æ³•å®šè³‡è¨Šå°ç…§è¡¨
        const STORE_INFOS = {
            "æ°¸æ…¶ä¸å‹•ç”¢å°ä¸­å…¬ç›Šå¤§æ¥­åº—": `æ°¸æ…¶ä¸å‹•ç”¢å°ä¸­å…¬ç›Šå¤§æ¥­åŠ ç›Ÿåº—\næ•¦ç’Ÿé–‹ç™¼è‚¡ä»½æœ‰é™å…¬å¸\nå¼µæ¬½å¼¼ï¼ˆ102ï¼‰ä¸­å¸‚ç¶“ç´€å­—ç¬¬00145è™Ÿ`,
            "æœ‰å·¢æ°æˆ¿å±‹13æœŸå¾©åŒ—ç«‹è¾°åº—": `æœ‰å·¢æ°æˆ¿å±‹13æœŸå¾©åŒ—ç«‹è¾°åŠ ç›Ÿåº—\nç«‹è¾°é–‹ç™¼è‚¡ä»½æœ‰é™å…¬å¸\nè¬ç²ç¾(105)ä¸­å¸‚ç¶“ç´€å­—ç¬¬01666è™Ÿ`
        };

        const SCENARIOS = [
            { value: "team_advantage", label: "ğŸ† åœ˜éšŠå„ªå‹¢ (ä¸‰åº—é€£è³£/è¡ŒéŠ·å¼·)", icon: "ğŸ’ª", content: "ä¸‰å®¶åº—é€£è³£ã€å°ä¸­æœ€å¤§æˆ¿ç”¢è³‡è¨Šç¶²ã€å¤šåª’é«”è¡ŒéŠ·ã€çŸ­å½±éŸ³è¡ŒéŠ·ã€ç¤¾ç¾¤è¡ŒéŠ·ã€ç©ºæ‹ã€ç¾å»£ç­‰" },
            { value: "buyer_match", label: "ğŸ¤ ç²¾æº–è²·æ–¹ (æˆ‘æœ‰å®¢)", icon: "ğŸ‘¥" },
            { value: "sold_report", label: "ğŸ’° æˆäº¤å ±å–œ (å‰›æˆäº¤)", icon: "ğŸ‰" },
            { value: "local_news", label: "ğŸ—ï¸ å¸‚å ´å¿«è¨Š (å°ä¸­åˆ©å¤š)", icon: "ğŸ“¢" },
            { value: "vacant_dev", label: "ğŸ  é–’ç½®é–‹ç™¼ (ç©ºå±‹æ´»åŒ–)", icon: "ğŸ•¸ï¸" },
            { value: "old_house", label: "ğŸšï¸ è€å±‹æ›æ–° (å±è€éƒ½æ›´)", icon: "ğŸ—ï¸" },
        ];

        const PAIN_POINTS = [
            { value: "none", label: "ç„¡ç‰¹åˆ¥ç—›é» (é€šç”¨)" },
            { value: "tax", label: "ğŸ’¸ ç¨…å‹™å•é¡Œ (æˆ¿åœ°åˆä¸€/åœŸå¢ç¨…)" },
            { value: "inheritance", label: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ç¹¼æ‰¿/åˆ†ç”¢å•é¡Œ" },
            { value: "vacant", label: "ğŸšï¸ å±‹æ³è®Šå·®/ä¸æƒ³ç®¡ç†" },
            { value: "privacy", label: "ğŸ¤« ä½èª¿è³£/ä¸æƒ³è¢«é„°å±…çŸ¥" },
            { value: "rezoning", label: "ğŸšœ é‡åŠƒå€åœŸåœ°è²·è³£" },
            { value: "cash_flow", label: "ğŸ’° ç¾é‡‘å‘¨è½‰éœ€æ±‚" },
            { value: "investment", label: "ğŸ“ˆ æŠ•è³‡ç²åˆ©äº†çµ" },
        ];

        const TONES = [
            { id: 'short', label: 'ç°¡è¨Š/LINE', icon: 'âš¡', desc: 'çŸ­ä¿ƒã€å¤šEmoji' },
            { id: 'neighbor', label: 'åƒé„°å±…èŠå¤©', icon: 'â˜•', desc: 'å£èªã€è¦ªåˆ‡' },
            { id: 'sincere', label: 'èª æ‡‡æº«æš–', icon: 'â¤ï¸', desc: 'æœ‰ç¦®ã€åŒç†å¿ƒ' },
            { id: 'professional', label: 'å°ˆæ¥­æ•¸æ“š', icon: 'ğŸ“Š', desc: 'å®¢è§€ã€åˆ†æ' },
            { id: 'direct', label: 'ç›´çƒå°æ±º', icon: 'ğŸ”¥', desc: 'å–®åˆ€ç›´å…¥' },
            { id: 'urgent', label: 'åè¬ç«æ€¥', icon: 'ğŸš¨', desc: 'æ€¥è¿«ã€å¸Œæœ›èƒ½ç›¡å¿«è¯ç¹«' },
        ];

        const FORMATS = [
            { id: 'letter', label: 'å¯¦é«”ä¿¡å‡½', icon: Icons.Mail, desc: 'å®Œæ•´é–‹ç™¼ä¿¡ï¼ŒåŒ…å«è‡ªæˆ‘ä»‹ç´¹èˆ‡è©³ç´°èªªæ˜' },
            { id: 'text', label: 'LINE/ç°¡è¨Š', icon: Icons.MessageCircle, desc: 'ç°¡çŸ­è¨Šæ¯ç‚ºä¸»ï¼Œåˆ†æ®µæ¸…æ¥š' },
            { id: 'script', label: 'é›»è©±è©±è¡“', icon: Icons.Phone, desc: 'é›»è©±é–‹ç™¼ï¼Œå¿«ç‹ æº–ï¼Œä¸å»¢è©±' },
        ];

        const LOCAL_NEWS_OPTIONS = [
            { value: "13_rezoning", label: "13æœŸé‡åŠƒå€", keywords: "13æœŸé‡åŠƒå€ã€ä½å¯†åº¦é«˜ç¶ è¦†ã€æ·é‹ç¶ ç·šæ²¿ç·šã€å“ç‰Œå»ºå•†é€²é§" },
            { value: "14_rezoning", label: "14æœŸé‡åŠƒå€", keywords: "14æœŸé‡åŠƒå€ã€æ¼¢ç¥æ´²éš›ç™¾è²¨ã€å°ä¸­å·¨è›‹ã€é«˜ç¶ è¦†ç”Ÿæ´»åœˆ" },
            { value: "mrt_rezoning", label: "æ©Ÿæ·é‡åŠƒå€", keywords: "æ©Ÿæ·ç‰¹å€ã€å¥½å¸‚å¤šå•†åœˆã€æ·é‹ç¸½ç«™ã€äº¤é€šä¾¿åˆ©" },
            { value: "general_rezoning", label: "é‡åŠƒå€å„ªå‹¢", keywords: "æ–°èˆˆé‡åŠƒå€ã€è¡—å»“æ•´é½Šã€å¢å€¼æ½›åŠ›é«˜ã€å…¬å…±å»ºè¨­å®Œå–„" },
            { value: "blue_line", label: "æ·é‹è—ç·šæ ¸å®š", keywords: "æ·é‹è—ç·šã€äº¤é€šåˆ©å¤šã€å¢å€¼æ½›åŠ›" },
            { value: "tsmc", label: "å°ç©é›»äºŒæœŸæ“´å» ", keywords: "ä¸­ç§‘æ“´å» ã€å·¥ç¨‹å¸«å‰›éœ€ã€æˆ¿åƒ¹æ”¯æ’" },
            { value: "shuinan", label: "æ°´æ¹³ç¶“è²¿åœ’å€", keywords: "æ°´æ¹³ç¶“è²¿ã€å¤–æº¢æ•ˆæ‡‰ã€é‡å¤§å»ºè¨­" },
            { value: "hanshin", label: "æ¼¢ç¥æ´²éš›ç™¾è²¨", keywords: "æ¼¢ç¥ç™¾è²¨ã€14æœŸé‡åŠƒå€ã€ç”Ÿæ´»æ©Ÿèƒ½" },
            { value: "74_road", label: "74è™Ÿå¿«é€Ÿé“è·¯", keywords: "74è™Ÿé“ã€äº¤é€šä¾¿åˆ©ã€ç”Ÿæ´»åœˆæ“´å¤§" },
        ];

        const STRUCTURE_ITEMS = [
            { id: 'intro', label: 'è‡ªæˆ‘ä»‹ç´¹ (æˆ‘æ˜¯èª°)' },
            { id: 'pain', label: 'ç—›é» (æ‚¨æ“”å¿ƒä»€éº¼)' },
            { id: 'scenario', label: 'åˆ‡å…¥é» (æˆ‘æœ‰ä»€éº¼)' },
        ];

        // --- é€šç”¨ UI å…ƒä»¶ ---

        const InputGroup = ({ title, icon: Icon, children, defaultOpen = true }) => {
            const [isOpen, setIsOpen] = useState(defaultOpen);
            return (
                <div className="border border-slate-700 rounded-lg overflow-hidden bg-slate-800/50 mb-4">
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full flex items-center justify-between p-3 bg-slate-800 text-slate-200 font-medium hover:bg-slate-700 transition-colors"
                    >
                        <div className="flex items-center gap-2 w-full">
                            {Icon && <Icon size={18} className="text-orange-500 flex-shrink-0" />}
                            <div className="flex-1">{title}</div>
                        </div>
                        {isOpen ? <Icons.ChevronUp size={16} /> : <Icons.ChevronDown size={16} />}
                    </button>
                    {isOpen && <div className="p-4 space-y-3">{children}</div>}
                </div>
            );
        };

        const Label = ({ children }) => <label className="block text-xs font-medium text-slate-400 mb-1">{children}</label>;

        const Input = (props) => (
            <input 
                {...props}
                className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent placeholder-slate-600 transition-all"
            />
        );

        const Select = (props) => (
            <div className="relative">
                <select 
                    {...props}
                    className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent appearance-none cursor-pointer transition-all"
                />
                <div className="absolute right-3 top-2.5 text-slate-500 pointer-events-none">
                    <Icons.ChevronDown size={16} />
                </div>
            </div>
        );

        const MultiSelectChip = ({ label, selected, onClick, icon }) => (
            <button
                onClick={onClick}
                className={`px-3 py-2 rounded-lg text-sm transition-all border flex items-center gap-2 text-left w-full h-full ${
                    selected 
                    ? 'bg-orange-600/30 border-orange-500 text-orange-200 shadow-[0_0_10px_rgba(234,88,12,0.3)]' 
                    : 'bg-slate-900 border-slate-700 text-slate-400 hover:bg-slate-800'
                }`}
            >
                <span className="flex-shrink-0">{selected ? 'âœ…' : icon || 'â¬œ'}</span>
                <span className="break-words">{label}</span>
            </button>
        );

        // --- AI å‘¼å«é‚è¼¯ ---

        const generateAIContent = async (data, apiKey) => {
            const { 
                agentName, agentPhone, teamName, storeName, targetName, community, scenarios, 
                tone, buyerType, buyerBudget, soldPrice, soldSpeed, 
                localNews, painPoints, format, structureOrder 
            } = data;

            const currentScenarios = scenarios.map(s => {
                const item = SCENARIOS.find(opt => opt.value === s);
                return item ? `${item.label} (å…§å®¹é‡é»: ${item.content || 'ç„¡'})` : s;
            }).join(", ");

            const currentPainPoints = painPoints.map(p => {
                const item = PAIN_POINTS.find(opt => opt.value === p);
                return item ? item.label : p;
            }).join(", ");

            const currentTone = TONES.find(t => t.id === tone)?.label || tone;
            const currentFormat = FORMATS.find(f => f.id === format);
            const newsItem = LOCAL_NEWS_OPTIONS.find(n => n.value === localNews);
            
            const structureLabel = structureOrder.map(id => STRUCTURE_ITEMS.find(i => i.id === id)?.label).join(" -> ");

            // å–å¾—åº—é ­æ³•å®šè³‡è¨Š
            const storeLegalInfo = STORE_INFOS[storeName] || "";

            let prompt = `
                Role: Professional Real Estate Agent in Taichung, Taiwan (Big Orange Team).
                Task: Write a sales copy for a property owner based on specific inputs.
                Language: Traditional Chinese (Taiwan), with Taichung local context.
                
                [Variables]
                - Agent Name: ${agentName}
                - Phone Number: ${agentPhone || "(è«‹å¡«å¯«é›»è©±)"}
                - Team: ${teamName}
                - Store: ${storeName}
                - Target Audience: ${targetName}
                - Community/Landmark: ${community || "è©²ç¤¾å€"}
                - Selected Scenarios (Cut-in Points): ${currentScenarios}
                - Selected Pain Points: ${currentPainPoints}
                - Tone/Style: ${currentTone}
                - Format: ${currentFormat?.label} (${currentFormat?.desc})
                - Structure Flow: ${structureLabel}
                
                [Details for Scenarios]
                ${scenarios.includes('buyer_match') ? `- Buyer Info: ${buyerType || "èª æ„è²·æ–¹"}, Budget: ${buyerBudget || "ç¬¦åˆè¡Œæƒ…"}` : ''}
                ${scenarios.includes('sold_report') ? `- Sold Price: ${soldPrice || "ä¿å¯†"}, Speed: ${soldSpeed || "å¿«é€Ÿ"}` : ''}
                ${scenarios.includes('local_news') ? `- Topic: ${newsItem?.label}, Keywords: ${newsItem?.keywords}` : ''}
                
                [Instructions]
                1. **Strictly follow the Structure Flow**: Organize the content in the order specified (${structureLabel}).
                2. **Format Specifics & Emoji Rules**:
                - **Phone Script (é›»è©±è©±è¡“)**: Use dialogue format. Concise. **STRICTLY NO EMOJIS.**
                - **Physical Letter (å¯¦é«”ä¿¡å‡½)**: Formal business layout. **STRICTLY NO EMOJIS.**
                - **LINE/SMS**: You MAY use emojis (e.g., ğŸŒŸ, ğŸ¡) to make it engaging, but do not overuse.
                3. **Content**:
                - Integrate ALL selected Scenarios and Pain Points naturally.
                - If "Team Advantage" is selected, mention: "ä¸‰å®¶åº—é€£è³£ã€å°ä¸­æœ€å¤§æˆ¿ç”¢è³‡è¨Šç¶²ã€å¤šåª’é«”è¡ŒéŠ·...".
                - Address pain points with empathy and professional solutions.
                - Ensure the content includes the Agent Name and Phone Number clearly at the end.
                ${storeLegalInfo ? `- **MANDATORY**: At the VERY BOTTOM of the message, you MUST append the following store legal information exactly as written:\n\n${storeLegalInfo}\n\n` : ''}
                4. **Output Style - CRITICAL**: 
                - **PURE PLAIN TEXT ONLY**. 
                - **DO NOT** use any Markdown formatting.
                - **DO NOT** use symbols like '**' (bold), '##' (header), or '__' (italic).
                - **DO NOT** include section headers like "[ç—›é»ï¼š...]" or "[åˆ‡å…¥é»ï¼š...]". The content should flow naturally as a single message.
                - Just write the text naturally with standard punctuation.
            `;

            // é‡è©¦æ©Ÿåˆ¶åƒæ•¸
            const delays = [1000, 2000, 4000, 8000, 16000]; // 1s, 2s, 4s, 8s, 16s
            let lastError = null;

            for (let attempt = 0; attempt <= delays.length; attempt++) {
                try {
                    let rawText = "";

                    if (apiKey) {
                        // --- æƒ…æ³ A: ä½¿ç”¨è€…æä¾›è‡ªè¨‚ Gemini API Key (Direct Call) ---
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error?.message || `Gemini API HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.error) throw new Error(result.error.message);
                        rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    } else {
                        // --- æƒ…æ³ B: æœªæä¾› Keyï¼Œä½¿ç”¨é è¨­ GAS ä¼ºæœå™¨ (Proxy Call) ---
                        // ä½¿ç”¨ text/plain ä»¥ç¬¦åˆ GAS çš„ CORS èˆ‡æ¥æ”¶è¦æ±‚
                        const response = await fetch(GAS_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            body: JSON.stringify({ prompt: prompt })
                        });

                        if (!response.ok) {
                            throw new Error(`GAS HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        
                        // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
                        if (data.error) {
                            throw new Error(`GAS å›å‚³éŒ¯èª¤: ${data.error}`);
                        }

                        // è§£æå›å‚³çµæ§‹
                        if (data.candidates && data.candidates.length > 0) {
                            rawText = data.candidates[0].content.parts[0].text;
                        } else {
                            // å˜—è©¦å…¶ä»–å¯èƒ½çš„æ¬„ä½ï¼Œæˆ–æ˜¯å›å‚³é è¨­è¨Šæ¯
                            rawText = data.text || "AI æ²’æœ‰å›å‚³ä»»ä½•å…§å®¹ã€‚";
                        }
                    }

                    if (!rawText) rawText = "AI ç”Ÿæˆç„¡å…§å®¹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";

                    // å¾Œè™•ç†ï¼šå¼·åˆ¶æ¸…é™¤ Markdown ç¬¦è™ŸåŠç‰¹å®šæ¨™é¡Œ
                    let cleanText = rawText
                        .replace(/\*\*/g, '')   // ç§»é™¤ç²—é«”ç¬¦è™Ÿ
                        .replace(/##/g, '')     // ç§»é™¤æ¨™é¡Œç¬¦è™Ÿ
                        .replace(/__/g, '')     // ç§»é™¤æ–œé«”ç¬¦è™Ÿ
                        .replace(/^#+\s/gm, '') // ç§»é™¤è¡Œé¦–çš„äº•å­—è™Ÿæ¨™é¡Œ
                        .replace(/\[ç—›é»ï¼šæ‚¨æ“”å¿ƒä»€éº¼\]/g, '') // ç§»é™¤ç‰¹å®šçµæ§‹æ¨™ç±¤ (å®Œæ•´)
                        .replace(/\[åˆ‡å…¥é»ï¼šæˆ‘æœ‰ä»€éº¼\]/g, '') // ç§»é™¤ç‰¹å®šçµæ§‹æ¨™ç±¤ (å®Œæ•´)
                        .replace(/\[è‡ªæˆ‘ä»‹ç´¹ \(æˆ‘æ˜¯èª°\)\]/g, '') // ç§»é™¤ç‰¹å®šçµæ§‹æ¨™ç±¤ (å®Œæ•´)
                        .replace(/\[ç—›é»\]/g, '') // ç§»é™¤ç°¡çŸ­æ¨™ç±¤
                        .replace(/\[åˆ‡å…¥é»\]/g, '') // ç§»é™¤ç°¡çŸ­æ¨™ç±¤
                        .replace(/\n\s*\n/g, '\n\n'); // ç§»é™¤å¤šé¤˜ç©ºè¡Œï¼Œä¿æŒæ®µè½æ•´æ½”

                    return cleanText;

                } catch (error) {
                    lastError = error;
                    // å¦‚æœæ˜¯æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œå°±ä¸å†ç­‰å¾…ï¼Œç›´æ¥è·³å‡ºè¿´åœˆ
                    if (attempt === delays.length) break;
                    
                    console.warn(`Attempt ${attempt + 1} failed, retrying in ${delays[attempt]}ms...`, error);
                    // ç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œé‡è©¦
                    await new Promise(resolve => setTimeout(resolve, delays[attempt]));
                }
            }

            // è‹¥æ‰€æœ‰å˜—è©¦éƒ½å¤±æ•—
            console.error("AI Error after retries:", lastError);
            const providerName = apiKey ? "è‡ªè¨‚ API Key" : "é è¨­ä¼ºæœå™¨ (GAS)";
            return `âš ï¸ AI ç”Ÿæˆå¤±æ•— (å·²è‡ªå‹•é‡è©¦ 5 æ¬¡) - ${providerName}ï¼š\n${lastError?.message}\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šï¼Œæˆ–ç¨å¾…ç‰‡åˆ»å†è©¦ã€‚`;
        };

        // --- ä¸»ç¨‹å¼å…ƒä»¶ ---

        function App() {
            // è®€å–æœ¬åœ°å„²å­˜çš„å§“åã€é›»è©±èˆ‡ API Key
            const savedAgentName = localStorage.getItem("gen_agentName") || "";
            const savedAgentPhone = localStorage.getItem("gen_agentPhone") || "";
            const savedApiKey = localStorage.getItem("gen_apiKey") || "";

            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [passwordInput, setPasswordInput] = useState("");
            const [loginApiKey, setLoginApiKey] = useState(savedApiKey); // ç™»å…¥ç•«é¢é¡¯ç¤ºçš„ Key
            const [loginError, setLoginError] = useState(false);

            // è‡ªè¨‚è¼¸å…¥çš„ State
            const [customScenarioInput, setCustomScenarioInput] = useState("");
            const [customPainPointInput, setCustomPainPointInput] = useState("");

            // å„²å­˜ç‹€æ…‹æŒ‡ç¤ºç‡ˆ
            const [showSaveIndicator, setShowSaveIndicator] = useState(false);

            // ä¸»ç¨‹å¼ä½¿ç”¨çš„ API Key State
            const [apiKey, setApiKey] = useState(savedApiKey);

            const [formData, setFormData] = useState({
                agentName: savedAgentName,
                agentPhone: savedAgentPhone, 
                teamName: "å¤§æ©˜åœ˜éšŠ",
                storeName: "",
                targetName: "å±‹ä¸»å¤§å“¥/å¤§å§",
                community: "",
                scenarios: ["buyer_match"], 
                tone: "neighbor",
                format: "letter", // é è¨­æ”¹ç‚º å¯¦é«”ä¿¡å‡½
                painPoints: ["none"], 
                structureOrder: ['intro', 'pain', 'scenario'],
                buyerType: "",
                buyerBudget: "",
                soldPrice: "",
                soldSpeed: "",
                localNews: "13_rezoning"
            });

            const [generatedText, setGeneratedText] = useState("");
            const [showToast, setShowToast] = useState(false);
            const [isMobilePanelOpen, setIsMobilePanelOpen] = useState(true);
            const [showSettings, setShowSettings] = useState(false);
            // Settings Modal ä¸­çš„è¼¸å…¥ State
            const [settingsApiKeyInput, setSettingsApiKeyInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            
            const outputRef = useRef(null);

            // ç›£è½ formData çš„è®ŠåŒ–ï¼Œå°‡å§“åèˆ‡é›»è©±å¯«å…¥ localStorage
            useEffect(() => {
                localStorage.setItem("gen_agentName", formData.agentName);
                localStorage.setItem("gen_agentPhone", formData.agentPhone);
                
                if (formData.agentName || formData.agentPhone) {
                    setShowSaveIndicator(true);
                    const timer = setTimeout(() => {
                        setShowSaveIndicator(false);
                    }, 2000);
                    return () => clearTimeout(timer);
                }
            }, [formData.agentName, formData.agentPhone]);

            // ç•¶ apiKey æ”¹è®Šæ™‚ï¼Œæ›´æ–° localStorage èˆ‡ Settings input
            useEffect(() => {
                if (apiKey) {
                    localStorage.setItem("gen_apiKey", apiKey);
                } else {
                    localStorage.removeItem("gen_apiKey");
                }
                setSettingsApiKeyInput(apiKey);
            }, [apiKey]);

            const currentFormat = FORMATS.find(f => f.id === formData.format);
            const FormatIcon = currentFormat ? currentFormat.icon : Icons.MessageCircle;

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleScenarioToggle = (value) => {
                setFormData(prev => {
                    const current = prev.scenarios;
                    if (current.includes(value)) {
                        return { ...prev, scenarios: current.filter(item => item !== value) }; 
                    } else {
                        return { ...prev, scenarios: [...current, value] }; 
                    }
                });
            };

            const handlePainPointToggle = (value) => {
                setFormData(prev => {
                    const current = prev.painPoints;
                    if (value === 'none') return { ...prev, painPoints: ['none'] };
                    
                    let newPoints = current.includes('none') ? [] : [...current];
                    
                    if (newPoints.includes(value)) {
                        newPoints = newPoints.filter(item => item !== value);
                    } else {
                        newPoints.push(value);
                    }
                    
                    if (newPoints.length === 0) newPoints = ['none'];
                    
                    return { ...prev, painPoints: newPoints };
                });
            };

            const addCustomScenario = () => {
                if (customScenarioInput.trim()) {
                    setFormData(prev => ({
                        ...prev,
                        scenarios: [...prev.scenarios, customScenarioInput.trim()]
                    }));
                    setCustomScenarioInput("");
                }
            };

            const addCustomPainPoint = () => {
                if (customPainPointInput.trim()) {
                    setFormData(prev => ({
                        ...prev,
                        painPoints: prev.painPoints.filter(p => p !== 'none').concat(customPainPointInput.trim())
                    }));
                    setCustomPainPointInput("");
                }
            };

            const moveStructure = (index, direction) => {
                setFormData(prev => {
                    const newOrder = [...prev.structureOrder];
                    if (direction === 'up' && index > 0) {
                        [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]];
                    } else if (direction === 'down' && index < newOrder.length - 1) {
                        [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]];
                    }
                    return { ...prev, structureOrder: newOrder };
                });
            };

            const handleReset = () => {
                setFormData({
                    agentName: localStorage.getItem("gen_agentName") || "",
                    agentPhone: localStorage.getItem("gen_agentPhone") || "",
                    teamName: "å¤§æ©˜åœ˜éšŠ",
                    storeName: "",
                    targetName: "å±‹ä¸»å¤§å“¥/å¤§å§",
                    community: "",
                    scenarios: ["buyer_match"],
                    tone: "neighbor",
                    format: "letter", // é è¨­ç‚ºå¯¦é«”ä¿¡å‡½
                    painPoints: ["none"],
                    structureOrder: ['intro', 'pain', 'scenario'],
                    buyerType: "",
                    buyerBudget: "",
                    soldPrice: "",
                    soldSpeed: "",
                    localNews: "13_rezoning"
                });
            };

            const handleLogin = (e) => {
                e.preventDefault();
                // é©—è­‰å¯†ç¢¼: Base64 è§£ç¢¼æ¯”å°
                if (btoa(passwordInput) === CORRECT_PASS_B64) {
                    setIsAuthenticated(true);
                    setLoginError(false);
                    // ç™»å…¥æ™‚å¦‚æœæœ‰è¼¸å…¥ Keyï¼Œå°±æ›´æ–° State (useEffect æœƒè‡ªå‹•å­˜åˆ° localStorage)
                    if (loginApiKey.trim()) {
                        setApiKey(loginApiKey.trim());
                    }
                } else {
                    setLoginError(true);
                }
            };

            const handleSaveSettings = () => {
                setApiKey(settingsApiKeyInput.trim());
                setShowSettings(false);
            };

            const handleClearSettings = () => {
                setApiKey("");
                setSettingsApiKeyInput("");
                localStorage.removeItem("gen_apiKey");
                // setShowSettings(false); // å¯ä»¥é¸æ“‡æ˜¯å¦é—œé–‰è¦–çª—
            };

            const generate = async () => {
                setIsLoading(true);
                if (outputRef.current) {
                    setTimeout(() => {
                        outputRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
                const text = await generateAIContent(formData, apiKey);
                setGeneratedText(text);
                setIsLoading(false);
            };

            const handleCopy = () => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(generatedText)
                        .then(() => triggerToast())
                        .catch(err => fallbackCopyTextToClipboard(generatedText));
                } else {
                    fallbackCopyTextToClipboard(generatedText);
                }
            };

            const fallbackCopyTextToClipboard = (text) => {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    const successful = document.execCommand('copy');
                    if (successful) triggerToast();
                    document.body.removeChild(textArea);
                } catch (err) {
                    console.error('Fallback copy error:', err);
                }
            };

            const triggerToast = () => {
                setShowToast(true);
                setTimeout(() => setShowToast(false), 2000);
            };

            const lineShareUrl = `https://line.me/R/msg/text/?${encodeURIComponent(generatedText)}`;

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4 font-sans text-slate-200">
                        <div className="bg-slate-800 p-8 rounded-xl shadow-2xl border border-slate-700 w-full max-w-sm animate-in fade-in zoom-in-95 duration-300">
                            <div className="flex justify-center mb-6">
                                <div className="p-4 rounded-full bg-slate-700/50 shadow-inner">
                                    <Icons.Lock size={32} className="text-orange-500" />
                                </div>
                            </div>
                            <h2 className="text-2xl font-bold text-white text-center mb-2">æˆ¿ä»²é–‹ç™¼ä¿¡ç”¢ç”Ÿå™¨ <span className="text-orange-500 text-sm">PRO v7.1</span></h2>
                            <p className="text-slate-400 text-center text-sm mb-6">è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¹¼çºŒä½¿ç”¨</p>
                            
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <input
                                        type="password"
                                        value={passwordInput}
                                        onChange={(e) => setPasswordInput(e.target.value)}
                                        placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                                        className={`w-full bg-slate-900 border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 transition-all text-center tracking-widest placeholder:tracking-normal placeholder:text-slate-600 ${loginError ? 'border-red-500' : 'border-slate-700'}`}
                                        autoFocus
                                    />
                                </div>

                                {/* API Key è¼¸å…¥å€ */}
                                <div>
                                    <div className="relative">
                                        <input 
                                            type="text"
                                            value={loginApiKey}
                                            onChange={(e) => setLoginApiKey(e.target.value)}
                                            placeholder="è¼¸å…¥å€‹äºº API Key (é¸å¡«)"
                                            className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 transition-all"
                                        />
                                        <div className="absolute right-3 top-3 text-slate-500 pointer-events-none">
                                            <Icons.Key size={16} />
                                        </div>
                                    </div>
                                    <p className="text-[10px] text-slate-400 mt-2 leading-relaxed">
                                        ğŸ’¡ <span className="text-yellow-500">å»ºè­°è¼¸å…¥å€‹äººå…è²» API Key</span> ä»¥é¿å…å…±ç”¨é¡åº¦é¡æ»¿ã€‚
                                        è‹¥æœªè¼¸å…¥ï¼Œç³»çµ±å°‡ä½¿ç”¨é è¨­çš„ GAS è«‹æ±‚ (å¯èƒ½æœƒæœ‰æ¬¡æ•¸é™åˆ¶)ã€‚
                                        è¼¸å…¥å¾Œå°‡è‡ªå‹•å„²å­˜æ–¼æœ¬åœ°ç«¯ï¼Œä¸‹æ¬¡ç„¡éœ€é‡è¤‡è¼¸å…¥ã€‚
                                    </p>
                                </div>
                                
                                {loginError && (
                                    <div className="text-red-400 text-xs text-center flex items-center justify-center gap-1 animate-pulse">
                                        <Icons.AlertTriangle size={12} /> å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥
                                    </div>
                                )}

                                <button
                                    type="submit"
                                    className="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3 rounded-lg transition-all active:scale-95 shadow-lg shadow-orange-500/20"
                                >
                                    é€²å…¥ç³»çµ±
                                </button>
                            </form>
                            <div className="mt-6 text-center text-xs text-slate-500">
                                ç¨‹å¼é–‹ç™¼ï¼šæ†²å“¥
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-orange-500/30 pb-10">
                    {/* Header */}
                    <header className="bg-slate-900 border-b border-slate-800 sticky top-0 z-20 shadow-md">
                        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className={`p-2 rounded-lg shadow-lg bg-gradient-to-br from-orange-500 to-red-600`}>
                                    <Icons.Bot size={20} className="text-white" />
                                </div>
                                <div>
                                    <h1 className="text-lg font-bold text-white tracking-wide flex items-center gap-2">
                                        æˆ¿ä»²é–‹ç™¼ä¿¡ç”¢ç”Ÿå™¨ <span className="text-orange-500 text-xs">PRO v7.1</span>
                                    </h1>
                                    <p className="text-xs text-slate-400">å¤§æ©˜åœ˜éšŠ x æ†²å“¥</p>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                {/* é»ƒè‰²é†’ç›®æŒ‰éˆ• */}
                                <button 
                                    onClick={() => setShowSettings(true)}
                                    className="px-3 py-2 bg-yellow-500 hover:bg-yellow-400 text-slate-900 rounded-md font-bold text-xs flex items-center gap-1 shadow-lg shadow-yellow-500/20 transition-all active:scale-95"
                                >
                                    <Icons.Settings size={16} />
                                    <span className="hidden md:inline">æ›´æ› API é‡‘é‘°</span>
                                </button>
                                <button 
                                    onClick={() => setIsMobilePanelOpen(!isMobilePanelOpen)}
                                    className="md:hidden p-2 text-slate-400 hover:text-white rounded-md hover:bg-slate-800"
                                >
                                    <div className={`transform transition-transform ${isMobilePanelOpen ? 'rotate-180' : ''}`}>
                                        <Icons.ChevronDown size={20} />
                                    </div>
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                            <div className="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in-95">
                                <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                                    <h3 className="font-bold text-white flex items-center gap-2">
                                        <Icons.Settings size={18} /> API é‡‘é‘°è¨­å®š
                                    </h3>
                                    <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-white">
                                        <Icons.X size={20} />
                                    </button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <p className="text-sm text-slate-300">
                                        æ‚¨å¯ä»¥åœ¨æ­¤æ›´æ›æ‚¨çš„å€‹äºº API Keyã€‚è¨­å®šå¾Œå°‡è‡ªå‹•è¦†è“‹èˆŠçš„ Key ä¸¦å„²å­˜æ–¼æœ¬åœ°ç«¯ã€‚
                                    </p>
                                    <div>
                                        <Label>Google Gemini API Key</Label>
                                        <Input 
                                            type="password" 
                                            value={settingsApiKeyInput} 
                                            onChange={(e) => setSettingsApiKeyInput(e.target.value)}
                                            placeholder="è¼¸å…¥æ–°çš„ API Key..." 
                                        />
                                    </div>
                                    
                                    <div className="bg-slate-800/50 p-3 rounded border border-slate-700/50 text-xs text-slate-400">
                                        <p>ç›®å‰ç‹€æ…‹ï¼š
                                            {apiKey ? (
                                                <span className="text-green-400 font-bold ml-1">ä½¿ç”¨å€‹äºº Key âœ…</span>
                                            ) : (
                                                <span className="text-yellow-500 font-bold ml-1">ä½¿ç”¨é è¨­ GAS (å…±ç”¨) âš ï¸</span>
                                            )}
                                        </p>
                                    </div>

                                    <div className="flex justify-between items-center text-xs pt-2 border-t border-slate-700">
                                        <button 
                                            onClick={handleClearSettings}
                                            className="text-red-400 hover:text-red-300 flex items-center gap-1"
                                        >
                                            <Icons.RotateCcw size={12} /> æ¸…é™¤ä¸¦ä½¿ç”¨é è¨­å€¼
                                        </button>
                                        <span className="text-slate-500">Key åƒ…å­˜æ–¼æœ¬æ©Ÿ</span>
                                    </div>
                                </div>
                                <div className="p-4 border-t border-slate-700 bg-slate-800 flex justify-end gap-2">
                                    <button 
                                        onClick={() => setShowSettings(false)}
                                        className="px-4 py-2 text-slate-300 hover:text-white transition-colors"
                                    >
                                        å–æ¶ˆ
                                    </button>
                                    <button 
                                        onClick={handleSaveSettings}
                                        className="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                                    >
                                        å„²å­˜è®Šæ›´
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <main className="max-w-7xl mx-auto p-4 md:p-6 flex flex-col md:flex-row gap-6">
                        
                        {/* Left Panel: Inputs */}
                        <div className={`md:w-1/3 lg:w-1/4 space-y-4 ${isMobilePanelOpen ? 'block' : 'hidden md:block'}`}>
                            
                            <InputGroup 
                                title={
                                    <div className="flex justify-between items-center w-full pr-4">
                                        <span>1. æ¥­å‹™å§“åèˆ‡åœ˜éšŠ</span>
                                        {showSaveIndicator && (
                                            <span className="text-xs text-green-400 flex items-center gap-1 animate-in fade-in">
                                                <Icons.CheckCircle size={12} /> å·²è‡ªå‹•å„²å­˜
                                            </span>
                                        )}
                                    </div>
                                } 
                                icon={Icons.User}
                            >
                                <div className="space-y-3">
                                    <div className="grid grid-cols-1 gap-2">
                                        <div>
                                            <Label>æ¥­å‹™å§“å</Label>
                                            <Input name="agentName" value={formData.agentName} onChange={handleChange} placeholder="è¼¸å…¥æ‚¨çš„ç¨±å‘¼ (ä¾‹: å°é™³)" />
                                        </div>
                                        <div>
                                            <Label>è¯çµ¡é›»è©±</Label>
                                            <div className="relative">
                                                <Input name="agentPhone" value={formData.agentPhone} onChange={handleChange} placeholder="09xx-xxx-xxx" />
                                                <div className="absolute right-3 top-2.5 text-slate-500 pointer-events-none">
                                                    <Icons.Smartphone size={16} />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 gap-3">
                                        <div>
                                            <Label>åœ˜éšŠåç¨±</Label>
                                            <Select name="teamName" value={formData.teamName} onChange={handleChange}>
                                                {TEAMS.map(t => <option key={t.value} value={t.value}>{t.label}</option>)}
                                            </Select>
                                        </div>
                                        <div>
                                            <Label>åˆ†åº—åç¨±</Label>
                                            <Select name="storeName" value={formData.storeName} onChange={handleChange}>
                                                {STORES.map(s => <option key={s.value} value={s.value}>{s.label}</option>)}
                                            </Select>
                                        </div>
                                    </div>
                                </div>
                            </InputGroup>

                            <InputGroup title="2. åˆ‡å…¥é» (è¤‡é¸)" icon={Icons.Briefcase}>
                                <div>
                                    <Label>ç›®æ¨™ç¨±å‘¼</Label>
                                    <Input name="targetName" value={formData.targetName} onChange={handleChange} placeholder="å±‹ä¸»å¤§å“¥" />
                                </div>
                                
                                <div className="mt-2">
                                    <Label>ç¤¾å€ / åœ°æ¨™ / å€åŸŸ / é¡å‹</Label>
                                    <Input 
                                        name="community" 
                                        value={formData.community} 
                                        onChange={handleChange} 
                                        placeholder="ä¾‹å¦‚ï¼šæƒ å®‡è§€å¸‚æ”¿ã€ä¸ƒæœŸã€å—å€ã€è¾²åœ°..." 
                                    />
                                    <p className="text-[10px] text-slate-500 mt-1">
                                        ğŸ’¡ æç¤ºï¼šå¯è¼¸å…¥å…·é«”ç¤¾å€ï¼Œä¹Ÿå¯ä»¥è¼¸å…¥å€åŸŸï¼ˆå¦‚ï¼šä¸ƒæœŸã€å—å€ï¼‰æˆ–æ˜¯ç‰©ä»¶é¡å‹ï¼ˆå¦‚ï¼šè¾²åœ°ã€é‡åŠƒå€ï¼‰ã€‚
                                    </p>
                                </div>
                                
                                <div className="mt-3">
                                    <Label>é¸æ“‡é–‹ç™¼åˆ‡å…¥é» (å¯å¤šé¸)</Label>
                                    {/* ç¶²æ ¼ä½ˆå±€ */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mt-1">
                                        {SCENARIOS.map(s => (
                                            <MultiSelectChip
                                                key={s.value}
                                                label={s.label}
                                                icon={s.icon}
                                                selected={formData.scenarios.includes(s.value)}
                                                onClick={() => handleScenarioToggle(s.value)}
                                            />
                                        ))}
                                        {/* é¡¯ç¤ºä½¿ç”¨è€…è‡ªè¨‚çš„åˆ‡å…¥é» */}
                                        {formData.scenarios
                                            .filter(s => !SCENARIOS.find(def => def.value === s))
                                            .map((s, idx) => (
                                                <MultiSelectChip
                                                    key={`custom-scenario-${idx}`}
                                                    label={s}
                                                    icon="âœ¨"
                                                    selected={true}
                                                    onClick={() => handleScenarioToggle(s)}
                                                />
                                        ))}
                                    </div>
                                    
                                    {/* è‡ªè¨‚åˆ‡å…¥é»è¼¸å…¥æ¡† */}
                                    <div className="flex gap-2 mt-2">
                                        <Input 
                                            value={customScenarioInput}
                                            onChange={(e) => setCustomScenarioInput(e.target.value)}
                                            placeholder="è¼¸å…¥è‡ªè¨‚åˆ‡å…¥é» (ä¾‹ï¼šæ€¥å”®å‡ºåœ‹)..."
                                            onKeyDown={(e) => e.key === 'Enter' && addCustomScenario()}
                                        />
                                        <button 
                                            onClick={addCustomScenario}
                                            className="bg-slate-700 hover:bg-slate-600 text-white p-2 rounded border border-slate-600 flex-shrink-0"
                                            title="æ–°å¢é¸é …"
                                        >
                                            <Icons.Plus size={18} />
                                        </button>
                                    </div>
                                </div>

                                {/* Dynamic Inputs */}
                                <div className="pt-2 border-t border-slate-700/50 mt-2 space-y-3">
                                    {formData.scenarios.includes('buyer_match') && (
                                        <div className="bg-slate-900/50 p-3 rounded border border-slate-700/50 animate-in fade-in space-y-2">
                                            <p className="text-xs text-orange-400 font-bold mb-1">ğŸ‘¥ è²·æ–¹è¨­å®š</p>
                                            <div>
                                                <Label>è²·æ–¹èƒŒæ™¯</Label>
                                                <Input name="buyerType" value={formData.buyerType} onChange={handleChange} placeholder="ä¾‹å¦‚ï¼šä¸­ç§‘å·¥ç¨‹å¸«" />
                                            </div>
                                            <div>
                                                <Label>è²·æ–¹é ç®— (è¬)</Label>
                                                <Input name="buyerBudget" value={formData.buyerBudget} onChange={handleChange} placeholder="ä¾‹å¦‚ï¼š2500" type="number" />
                                            </div>
                                        </div>
                                    )}
                                    {formData.scenarios.includes('sold_report') && (
                                        <div className="bg-slate-900/50 p-3 rounded border border-slate-700/50 animate-in fade-in space-y-2">
                                            <p className="text-xs text-orange-400 font-bold mb-1">ğŸ‰ æˆäº¤è¨­å®š</p>
                                            <div>
                                                <Label>æˆäº¤ç¸½åƒ¹ (è¬)</Label>
                                                <Input name="soldPrice" value={formData.soldPrice} onChange={handleChange} placeholder="ä¾‹å¦‚ï¼š3200" type="number" />
                                            </div>
                                            <div>
                                                <Label>æˆäº¤é€Ÿåº¦</Label>
                                                <Input name="soldSpeed" value={formData.soldSpeed} onChange={handleChange} placeholder="ä¾‹å¦‚ï¼šä¸‰å¤©ç§’æ®º" />
                                            </div>
                                        </div>
                                    )}
                                    {formData.scenarios.includes('local_news') && (
                                        <div className="bg-slate-900/50 p-3 rounded border border-slate-700/50 animate-in fade-in">
                                            <p className="text-xs text-orange-400 font-bold mb-1">ğŸ“¢ è©±é¡Œè¨­å®š</p>
                                            <Label>é¸æ“‡è©±é¡Œ</Label>
                                            <Select name="localNews" value={formData.localNews} onChange={handleChange}>
                                                {LOCAL_NEWS_OPTIONS.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                                            </Select>
                                        </div>
                                    )}
                                </div>
                            </InputGroup>

                            <InputGroup title="3. ç­–ç•¥èˆ‡ç—›é» (è¤‡é¸)" icon={Icons.Bot}>
                                <div>
                                    <Label>å±‹ä¸»ç—›é»çŒœæ¸¬ (å¯å¤šé¸)</Label>
                                    {/* ç¶²æ ¼ä½ˆå±€ */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mt-1">
                                        {PAIN_POINTS.map(p => (
                                            <MultiSelectChip
                                                key={p.value}
                                                label={p.label}
                                                selected={formData.painPoints.includes(p.value)}
                                                onClick={() => handlePainPointToggle(p.value)}
                                            />
                                        ))}
                                        {/* é¡¯ç¤ºä½¿ç”¨è€…è‡ªè¨‚çš„ç—›é» */}
                                        {formData.painPoints
                                            .filter(p => !PAIN_POINTS.find(def => def.value === p))
                                            .map((p, idx) => (
                                                <MultiSelectChip
                                                    key={`custom-pain-${idx}`}
                                                    label={p}
                                                    icon="ğŸ”´"
                                                    selected={true}
                                                    onClick={() => handlePainPointToggle(p)}
                                                />
                                        ))}
                                    </div>
                                    
                                    {/* è‡ªè¨‚ç—›é»è¼¸å…¥æ¡† */}
                                    <div className="flex gap-2 mt-2">
                                        <Input 
                                            value={customPainPointInput}
                                            onChange={(e) => setCustomPainPointInput(e.target.value)}
                                            placeholder="è¼¸å…¥è‡ªè¨‚ç—›é» (ä¾‹ï¼šæ€¥éœ€ç¾é‡‘)..."
                                            onKeyDown={(e) => e.key === 'Enter' && addCustomPainPoint()}
                                        />
                                        <button 
                                            onClick={addCustomPainPoint}
                                            className="bg-slate-700 hover:bg-slate-600 text-white p-2 rounded border border-slate-600 flex-shrink-0"
                                            title="æ–°å¢é¸é …"
                                        >
                                            <Icons.Plus size={18} />
                                        </button>
                                    </div>
                                </div>
                            </InputGroup>

                            <InputGroup title="4. èªæ°£èˆ‡æ ¼å¼" icon={Icons.MessageCircle}>
                                <div className="space-y-5">
                                    
                                    {/* Output Format */}
                                    <div>
                                        <Label>è¼¸å‡ºæ ¼å¼ (Output Format)</Label>
                                        <div className="grid grid-cols-3 gap-2 mt-1">
                                            {FORMATS.map(fmt => (
                                                <button
                                                    key={fmt.id}
                                                    onClick={() => setFormData(prev => ({ ...prev, format: fmt.id }))}
                                                    className={`flex flex-col items-center justify-center p-2 rounded border transition-all ${
                                                        formData.format === fmt.id 
                                                        ? 'bg-blue-500/20 border-blue-500 text-blue-400' 
                                                        : 'bg-slate-900 border-slate-700 text-slate-400 hover:bg-slate-800'
                                                    }`}
                                                    title={fmt.desc}
                                                >
                                                    <fmt.icon size={16} className="mb-1" />
                                                    <span className="text-xs">{fmt.label.split('/')[0]}</span>
                                                </button>
                                            ))}
                                        </div>
                                        <p className="text-[10px] text-slate-500 mt-1">
                                            {FORMATS.find(f => f.id === formData.format)?.desc}
                                        </p>
                                    </div>

                                    {/* Structure Ordering */}
                                    <div>
                                        <Label>æ–‡æ¡ˆçµæ§‹é †åº (é»ç®­é ­èª¿æ•´)</Label>
                                        <div className="bg-slate-900 rounded border border-slate-700 p-2 space-y-1 mt-1">
                                            {formData.structureOrder.map((itemId, index) => {
                                                const item = STRUCTURE_ITEMS.find(i => i.id === itemId);
                                                return (
                                                    <div key={itemId} className="flex items-center justify-between bg-slate-800 px-3 py-2 rounded text-sm text-slate-300">
                                                        <span>{index + 1}. {item?.label}</span>
                                                        <div className="flex gap-1">
                                                            <button 
                                                                onClick={() => moveStructure(index, 'up')}
                                                                disabled={index === 0}
                                                                className="p-1 hover:bg-slate-700 rounded disabled:opacity-30"
                                                            >
                                                                <Icons.ArrowUp size={14} />
                                                            </button>
                                                            <button 
                                                                onClick={() => moveStructure(index, 'down')}
                                                                disabled={index === formData.structureOrder.length - 1}
                                                                className="p-1 hover:bg-slate-700 rounded disabled:opacity-30"
                                                            >
                                                                <Icons.ArrowDown size={14} />
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    {/* Tone */}
                                    <div>
                                        <Label>èªæ°£é¢¨æ ¼ (Tone)</Label>
                                        <div className="grid grid-cols-2 gap-2 mt-1">
                                            {TONES.map(mode => (
                                                <button
                                                    key={mode.id}
                                                    onClick={() => setFormData(prev => ({ ...prev, tone: mode.id }))}
                                                    className={`flex items-center gap-2 px-2 py-2 rounded border transition-all text-left ${
                                                        formData.tone === mode.id 
                                                        ? 'bg-orange-500/20 border-orange-500 text-orange-400' 
                                                        : 'bg-slate-900 border-slate-700 text-slate-400 hover:bg-slate-800'
                                                    }`}
                                                >
                                                    <span className="text-lg">{mode.icon}</span>
                                                    <div className="flex flex-col">
                                                        <span className="text-xs font-bold">{mode.label}</span>
                                                        <span className="text-[9px] opacity-70">{mode.desc}</span>
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </InputGroup>
                            
                            <button 
                                onClick={handleReset}
                                className="w-full flex items-center justify-center gap-2 p-2 bg-slate-800 hover:bg-red-900/30 text-slate-400 hover:text-red-400 rounded-lg border border-transparent hover:border-red-900/50 transition-all text-sm mb-3"
                            >
                                <Icons.RotateCcw size={14} /> é‡ç½®æ‰€æœ‰è¨­å®š
                            </button>

                            <button 
                                onClick={generate}
                                className="w-full flex items-center justify-center gap-2 p-3 bg-orange-600 hover:bg-orange-500 text-white rounded-lg font-bold shadow-lg shadow-orange-500/20 active:scale-95 transition-all text-base border border-orange-500 animate-in fade-in zoom-in-95"
                            >
                                <Icons.Sparkles size={18} /> AI ç«‹å³ç”¢å‡º
                            </button>

                        </div>

                        {/* Right Panel: Output */}
                        <div ref={outputRef} className="md:w-2/3 lg:w-3/4 flex flex-col h-full min-h-[500px]">
                            
                            {/* Card */}
                            <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl flex flex-col h-full overflow-hidden relative">
                                
                                {/* Loading Overlay */}
                                {isLoading && (
                                    <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-10 flex items-center justify-center flex-col gap-3">
                                        <Icons.RefreshCw className="animate-spin text-orange-500" size={40} />
                                        <p className="text-orange-400 font-medium animate-pulse">
                                            AI æ­£åœ¨çµ„è£æœ€å¼·æ–‡æ¡ˆ...
                                        </p>
                                        <p className="text-slate-400 text-xs">æ­£åœ¨åˆ†æï¼š{formData.scenarios.length} å€‹åˆ‡å…¥é»ã€{formData.painPoints.length} å€‹ç—›é»</p>
                                    </div>
                                )}

                                {/* Toolbar */}
                                <div className="p-4 border-b border-slate-700 flex flex-wrap items-center justify-between gap-3 bg-slate-800/80 backdrop-blur">
                                    <div className="flex items-center gap-2 overflow-x-auto no-scrollbar max-w-[60%]">
                                        <span className={`px-2 py-1 rounded text-xs font-bold tracking-wider uppercase flex-shrink-0 flex items-center gap-1 ${
                                            formData.format === 'text' ? 'bg-green-500/20 text-green-400' :
                                            formData.format === 'letter' ? 'bg-yellow-500/20 text-yellow-400' :
                                            'bg-pink-500/20 text-pink-400'
                                        }`}>
                                            <FormatIcon size={12} />
                                            {currentFormat?.label.split('/')[0]}
                                        </span>
                                        
                                        {formData.scenarios.length > 0 && (
                                            <span className="px-2 py-1 rounded text-xs font-bold bg-blue-500/20 text-blue-400 flex-shrink-0">
                                                {formData.scenarios.length} å€‹åˆ‡å…¥é»
                                            </span>
                                        )}
                                    </div>

                                    <div className="flex items-center gap-2">
                                        <button 
                                            onClick={generate}
                                            className="flex items-center gap-2 px-4 py-1.5 text-sm rounded-lg transition-all border shadow-lg active:scale-95 bg-slate-700 hover:bg-slate-600 text-slate-200 border-slate-600"
                                        >
                                            <Icons.RefreshCw size={14} />
                                            <span>é‡æ–°ç”Ÿæˆ</span>
                                        </button>
                                    </div>
                                </div>

                                {/* Text Area */}
                                <div className="flex-1 relative group bg-slate-900/50">
                                    <textarea
                                        id="output-textarea"
                                        value={generatedText}
                                        onChange={(e) => setGeneratedText(e.target.value)}
                                        placeholder="ç­‰å¾…ç”Ÿæˆä¸­... è«‹è¨­å®šå·¦å´åƒæ•¸ä¸¦é»æ“Šå·¦ä¸‹è§’çš„ã€ŒAI ç«‹å³ç”¢å‡ºã€"
                                        className="w-full h-full min-h-[500px] p-6 bg-transparent text-slate-100 text-base leading-relaxed resize-y focus:outline-none transition-opacity font-mono"
                                        spellCheck="false"
                                    />
                                    {generatedText && (
                                        <div className="absolute top-4 right-4 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity">
                                            <span className="text-xs text-slate-500 bg-slate-900/80 px-2 py-1 rounded">å¯ç›´æ¥ç·¨è¼¯</span>
                                        </div>
                                    )}
                                </div>

                                {/* Action Footer */}
                                <div className="p-4 bg-slate-800 border-t border-slate-700 flex flex-col sm:flex-row gap-3">
                                    <button 
                                        onClick={handleCopy}
                                        className="flex-1 flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition-all active:scale-95 border border-slate-600"
                                    >
                                        {showToast ? <Icons.CheckCircle size={20} className="text-green-500" /> : <Icons.Copy size={20} />}
                                        {showToast ? 'å·²è¤‡è£½ï¼' : 'è¤‡è£½æ–‡æ¡ˆ'}
                                    </button>
                                    
                                    <a 
                                        href={lineShareUrl}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-[#06C755] hover:bg-[#05b54d] text-white font-bold py-3 px-6 rounded-lg shadow-lg shadow-green-500/20 transition-all active:scale-95"
                                    >
                                        <Icons.Share2 size={20} />
                                        <span className="hidden sm:inline">LINE åˆ†äº«</span>
                                        <span className="sm:hidden">LINE</span>
                                    </a>
                                </div>

                            </div>

                            <div className="mt-4 text-center text-slate-500 text-xs flex flex-col gap-1">
                                <p>ğŸ’¡ æç¤ºï¼šæŒ‰ä½ç”Ÿæˆæ¡†å³ä¸‹è§’å¯è‡ªç”±æ‹–æ‹‰é«˜åº¦ã€‚ä¸æ»¿æ„çµæœï¼Ÿé»æ“Š <Icons.RefreshCw className="inline" size={12}/> å¯è«‹ AI é‡æ–°æ½¤é£¾ã€‚</p>
                                <p className="mt-2 opacity-50">ç¨‹å¼é–‹ç™¼ï¼šæ†²å“¥</p>
                            </div>

                        </div>
                    </main>

                    {/* Toast Notification */}
                    <div className={`fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-xl border border-slate-700 flex items-center gap-2 transition-all duration-300 transform ${showToast ? 'translate-y-0 opacity-100' : 'translate-y-10 opacity-0 pointer-events-none'}`}>
                        <Icons.CheckCircle size={16} className="text-green-500" />
                        <span className="text-sm font-medium">æ–‡æ¡ˆå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</span>
                    </div>

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
